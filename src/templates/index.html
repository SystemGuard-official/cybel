<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <link href="https://unpkg.com/tailwindcss@^2.0/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="flex h-screen">
        <!-- Side Navigation -->
        <div class="w-64 bg-gray-900 p-4 flex flex-col">
            <button onclick="startNewChat()" class="text-white border border-white/20 rounded-md p-3 text-sm mb-4 hover:bg-gray-700 transition-colors">
                + New chat
            </button>
            <div id="chat-history" class="flex-1 overflow-y-auto text-white/60">
                <!-- Chat history items will be added here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4">
                <!-- Messages will be added here -->
            </div>

            <!-- Input Area -->
            <div class="border-t p-4 bg-white">
                <div class="max-w-3xl mx-auto relative">
                    <textarea id="message-input" rows="1" class="w-full p-3 pr-12 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500 resize-none" placeholder="Send a message"></textarea>
                    <button onclick="sendMessage()" class="absolute right-2 bottom-2 p-1 text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
let currentChatId = Date.now();
let chats = {};

function startNewChat() {
    currentChatId = Date.now();
    chats[currentChatId] = [];
    updateChatHistory();
    document.getElementById('chat-messages').innerHTML = '';
}

function updateChatHistory() {
    const historyDiv = document.getElementById('chat-history');
    historyDiv.innerHTML = '';
    Object.entries(chats).reverse().forEach(([chatId, messages]) => {
        const title = messages.length > 0 ? messages[0].content.substring(0, 30) + '...' : 'New Chat';
        const div = document.createElement('div');
        div.className = 'p-3 hover:bg-gray-800 cursor-pointer rounded mb-1 text-sm';
        div.textContent = title;
        div.onclick = () => loadChat(chatId);
        historyDiv.appendChild(div);
    });
}

function loadChat(chatId) {
    currentChatId = chatId;
    const messages = chats[chatId] || [];
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = '';
    messages.forEach(msg => addMessageToUI(msg));
}

function addMessageToUI(message) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-4 p-4 ${message.role === 'user' ? 'bg-white' : 'bg-gray-50'}`;

    const iconDiv = document.createElement('div');
    iconDiv.className = 'w-8 h-8 rounded-full flex items-center justify-center';
    iconDiv.style.backgroundColor = message.role === 'user' ? '#5437DB' : '#19C37D';
    iconDiv.textContent = message.role === 'user' ? 'U' : 'A';
    iconDiv.style.color = 'white';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'flex-1 max-w-3xl';
    contentDiv.innerHTML = `
        <p class="text-gray-800">${message.content}</p>
        ${message.follow_ups ? `
            <div class="mt-4 flex flex-wrap gap-2">
                ${message.follow_ups.map(q => `
                    <button onclick="handleFollowUp('${q}')" 
                            class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700">
                        ${q}
                    </button>
                `).join('')}
            </div>
        ` : ''}
    `;

    messageDiv.appendChild(iconDiv);
    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';

    if (!chats[currentChatId]) {
        chats[currentChatId] = [];
    }

    const userMessage = { role: 'user', content: message };
    chats[currentChatId].push(userMessage);
    addMessageToUI(userMessage);
    updateChatHistory();

    try {
        const response = await fetch('/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: message })
        });
        const data = await response.json();
        
        const assistantMessage = {
            role: 'assistant',
            content: data.answer,
            follow_ups: data.follow_ups
        };
        chats[currentChatId].push(assistantMessage);
        addMessageToUI(assistantMessage);
    } catch (error) {
        console.error('Error:', error);
    }
}

function handleFollowUp(question) {
    document.getElementById('message-input').value = question;
    sendMessage();
}

// Initialize with a new chat
startNewChat();

// Handle enter key
document.getElementById('message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>
</body>
</html>